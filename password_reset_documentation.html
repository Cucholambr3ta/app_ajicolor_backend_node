<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentación Técnica: Reseteo de Contraseña</title>
    <style>
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        h2 {
            color: #2980b9;
            margin-top: 40px;
            border-left: 5px solid #2980b9;
            padding-left: 15px;
        }
        h3 {
            color: #16a085;
            margin-top: 25px;
        }
        .card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        pre {
            background: #2d3436;
            color: #dfe6e9;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
        }
        code {
            font-family: 'Consolas', 'Monaco', monospace;
            color: #e74c3c;
            background: #fdf2f0;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .note {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
        }
        .success {
            background-color: #d4edda;
            border-left: 5px solid #28a745;
            padding: 15px;
            margin: 20px 0;
        }
        ul, ol {
            padding-left: 25px;
        }
        li {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <h1>Documentación Técnica: Sistema de Reseteo de Contraseña</h1>
    
    <div class="card">
        <p>Este documento explica detalladamente cómo se implementó el flujo de recuperación de contraseña en la aplicación <strong>App Poleras</strong>. Incluye explicaciones paso a paso del código tanto en el Backend (Node.js) como en la App Móvil (Android/Kotlin).</p>
    </div>

    <h2>1. Backend (Node.js + Express + MongoDB)</h2>
    <p>El backend es responsable de generar el código seguro, enviarlo por correo y validar el cambio de contraseña.</p>

    <h3>Paso 1.1: Modelo de Usuario (User.js)</h3>
    <p>Se modificó el esquema de la base de datos para almacenar temporalmente el código de recuperación y su fecha de expiración.</p>
    <pre>
// src/models/User.js
const userSchema = new mongoose.Schema({
    // ... otros campos (nombre, email, password) ...
    
    // Campo para guardar el código de 6 dígitos
    resetPasswordToken: {
        type: String,
        required: false,
    },
    // Campo para definir cuándo expira el código
    resetPasswordExpires: {
        type: Date,
        required: false,
    },
});
    </pre>

    <h3>Paso 1.2: Servicio de Email (sendEmail.js)</h3>
    <p>Se creó una utilidad para enviar correos reales usando la librería <code>nodemailer</code>. Esto permite conectar con servicios como Gmail, Outlook o SendGrid.</p>
    <pre>
// src/utils/sendEmail.js
const nodemailer = require('nodemailer');

const sendEmail = async (options) => {
  // Configuración del servidor SMTP (se lee desde variables de entorno .env)
  const transporter = nodemailer.createTransport({
    host: process.env.SMTP_HOST,
    port: process.env.SMTP_PORT,
    auth: {
      user: process.env.SMTP_EMAIL,
      pass: process.env.SMTP_PASSWORD,
    },
  });

  // Envío del correo
  const info = await transporter.sendMail({
    from: `${process.env.FROM_NAME} <${process.env.FROM_EMAIL}>`,
    to: options.email,
    subject: options.subject,
    text: options.message,
  });
};
    </pre>

    <h3>Paso 1.3: Rutas de Autenticación (authRoutes.js)</h3>
    <p>Se implementaron dos endpoints clave:</p>
    
    <h4>A. Solicitar Recuperación (POST /recover)</h4>
    <p>Genera el código y lo envía por correo.</p>
    <pre>
// src/routes/authRoutes.js

router.post('/recover', async (req, res) => {
    const { email } = req.body;
    // 1. Buscar usuario
    const user = await User.findOne({ email });
    if (!user) return res.status(404).json({ message: 'Usuario no encontrado' });

    // 2. Generar código de 6 dígitos aleatorio
    const recoveryCode = Math.floor(100000 + Math.random() * 900000).toString();
    
    // 3. Guardar en BD con expiración de 15 minutos
    user.resetPasswordToken = recoveryCode;
    user.resetPasswordExpires = Date.now() + 15 * 60 * 1000; 
    await user.save();

    // 4. Enviar Email
    try {
        await sendEmail({
            email: user.email,
            subject: 'Recuperación de contraseña',
            message: `Tu código es: ${recoveryCode}`,
        });
        
        // SEGURIDAD: En producción NO devolvemos el código en la respuesta
        res.json({ 
            message: 'Código enviado',
            recoveryCode: process.env.NODE_ENV === 'test' ? recoveryCode : undefined
        });
    } catch (error) {
        // Manejo de errores...
    }
});
    </pre>

    <h4>B. Resetear Contraseña (POST /reset-password)</h4>
    <p>Valida el código y actualiza la contraseña.</p>
    <pre>
router.post('/reset-password', async (req, res) => {
    const { email, recoveryCode, newPassword } = req.body;

    // 1. Buscar usuario que coincida con email, código Y que el código no haya expirado
    const user = await User.findOne({ 
        email,
        resetPasswordToken: recoveryCode,
        resetPasswordExpires: { $gt: Date.now() } // $gt = Greater Than (Mayor que ahora)
    });

    if (!user) return res.status(400).json({ message: 'Código inválido o expirado' });

    // 2. Actualizar contraseña (el modelo se encarga de hashearla)
    user.password = newPassword;
    
    // 3. Limpiar el código usado para que no se pueda reutilizar
    user.resetPasswordToken = undefined;
    user.resetPasswordExpires = undefined;
    await user.save();

    res.json({ message: 'Contraseña actualizada exitosamente' });
});
    </pre>

    <h2>2. App Android (Kotlin + Jetpack Compose)</h2>
    <p>La aplicación móvil gestiona la interfaz de usuario y la comunicación con el backend.</p>

    <h3>Paso 2.1: Pantalla de Solicitud (PasswordRecoveryScreen.kt)</h3>
    <p>El usuario ingresa su email. Si el envío es exitoso, la app navega automáticamente a la siguiente pantalla.</p>
    <pre>
// Si el estado indica éxito (código enviado)
if (state.success) {
    LaunchedEffect(Unit) {
        // Navegar a la pantalla de ResetPassword pasando el email como argumento
        navController.navigate(Screen.ResetPassword.createRoute(email))
    }
}
    </pre>

    <h3>Paso 2.2: Pantalla de Reseteo (ResetPasswordScreen.kt)</h3>
    <p>Esta es una <strong>nueva pantalla</strong> creada para ingresar el código de 6 dígitos y la nueva contraseña.</p>
    <pre>
// com/example/appajicolorgrupo4/ui/screens/ResetPasswordScreen.kt

@Composable
fun ResetPasswordScreen(navController: NavController, viewModel: PasswordRecoveryViewModel, email: String) {
    // Variables de estado para los campos de texto
    var code by remember { mutableStateOf("") }
    var newPassword by remember { mutableStateOf("") }
    
    // ... UI con TextFields ...

    Button(
        onClick = {
            // Llamada al ViewModel para resetear
            viewModel.resetearContrasena(email, code, newPassword)
        },
        // El botón solo se activa si los datos son válidos
        enabled = code.length == 6 && newPassword.isNotEmpty()
    ) {
        Text("Cambiar Contraseña")
    }

    // Si el cambio es exitoso, volver al Login
    if (state.success) {
        navController.navigate(Screen.Login.route)
    }
}
    </pre>

    <h3>Paso 2.3: Lógica de Negocio (PasswordRecoveryViewModel.kt)</h3>
    <p>El ViewModel conecta la UI con la API (Retrofit).</p>
    <pre>
fun resetearContrasena(email: String, recoveryCode: String, newPassword: String) {
    viewModelScope.launch {
        _state.value = _state.value.copy(isLoading = true)
        try {
            // Llamada HTTP al backend
            val response = apiService.resetPassword(mapOf(
                "email" to email,
                "recoveryCode" to recoveryCode,
                "newPassword" to newPassword
            ))
            
            if (response.isSuccessful) {
                _state.value = _state.value.copy(success = true)
            } else {
                _state.value = _state.value.copy(errorMsg = "Código inválido")
            }
        } catch (e: Exception) {
            // Manejo de errores de red
        }
    }
}
    </pre>

    <h2>3. Seguridad y Testing</h2>
    <div class="note">
        <strong>Medidas de Seguridad Clave:</strong>
        <ul>
            <li><strong>Expiración:</strong> El código deja de ser válido a los 15 minutos.</li>
            <li><strong>Un solo uso:</strong> Una vez usada, la contraseña se cambia y el código se borra.</li>
            <li><strong>Ocultamiento:</strong> El código nunca se expone en la API pública (excepto en modo test).</li>
            <li><strong>Validación de Roles:</strong> Se añadieron tests de seguridad (<code>security.test.js</code>) para asegurar que solo los administradores puedan tocar datos sensibles de productos.</li>
        </ul>
    </div>

    <div class="success">
        <strong>Estado de las Pruebas:</strong>
        <p>Se ejecutaron todos los tests automatizados y pasaron exitosamente (16/16 tests).</p>
        <ul>
            <li>✅ Flujo de Registro y Login</li>
            <li>✅ Flujo de Recuperación de Contraseña (Email -> Código -> Reset)</li>
            <li>✅ Flujo de Compra</li>
            <li>✅ Seguridad de Roles (Admin vs User)</li>
        </ul>
    </div>

</body>
</html>
